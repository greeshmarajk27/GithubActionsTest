name: Approval listener

on:
  issue_comment:
    types: [created]

jobs:
  check-approval:
    runs-on: ubuntu-latest
    if: >
      github.event.comment.body == '/approve'
    steps:
      - name: Verify commenter permission
        uses: actions/github-script@v7
        with:
          script: |
            const perm = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.comment.user.login
            });

            if (!['admin', 'write'].includes(perm.data.permission)) {
              core.setFailed("User not authorized to approve.");
            }

      - name: Trigger continuation workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "continue.yml",
              ref: "main"
            });
